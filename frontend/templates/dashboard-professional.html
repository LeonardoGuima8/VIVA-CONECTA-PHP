<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Profissional · VIVA CONECTA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 font-[Inter]">
  <header class="sticky top-0 z-20 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a class="flex items-center gap-2 text-white font-semibold text-lg" href="./index.html">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-secondary/20 text-secondary">VC</span>
        <span>Área do Profissional</span>
      </a>
      <nav class="flex items-center gap-5 text-sm text-slate-400">
        <a class="hover:text-white transition" href="./dashboard-professional.html">Resumo</a>
        <a class="hover:text-white transition" href="./appointments.html">Agenda</a>
        <a class="hover:text-white transition" href="./reviews.html">Avaliações</a>
      </nav>
      <div class="flex items-center gap-3 text-sm">
        <span class="hidden sm:flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 text-slate-200">Dr. Antônio</span>
        <a class="inline-flex px-3 py-2 rounded-lg bg-secondary text-white hover:bg-secondary/90 transition" href="./logout.html">Sair</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-12 space-y-10">
    <section class="grid md:grid-cols-3 gap-6">
      <article class="rounded-3xl bg-gradient-to-br from-secondary/40 to-secondary/10 border border-secondary/30 p-6">
        <p class="text-xs uppercase tracking-widest text-slate-200">Consultas confirmadas</p>
        <p class="mt-3 text-2xl font-semibold text-white" id="confirmed">18 nesta semana</p>
        <p class="mt-2 text-sm text-slate-200">Sincronizado com `/api/v1/appointments`.</p>
      </article>
      <article class="rounded-3xl bg-slate-800 border border-slate-700 p-6">
        <p class="text-xs uppercase tracking-widest text-slate-400">Avaliação média</p>
        <p class="mt-3 text-2xl font-semibold text-white" id="rating">4.82 · 214 avaliações</p>
        <p class="mt-2 text-sm text-slate-400">Atualizado via `/api/v1/professionals/:id/reviews` + edge function `ranking_recalculate`.</p>
      </article>
      <article class="rounded-3xl bg-slate-800 border border-slate-700 p-6">
        <p class="text-xs uppercase tracking-widest text-slate-400">SLA de chat</p>
        <p class="mt-3 text-2xl font-semibold text-white" id="sla">Tempo médio 3m45s</p>
        <p class="mt-2 text-sm text-slate-400">Dados gerados via `/api/v1/chat/threads`.</p>
      </article>
    </section>

    <section class="rounded-3xl bg-slate-800/80 border border-slate-700 p-6">
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-white">Agenda dos próximos dias</h2>
          <p class="text-sm text-slate-400">Consulte slots sincronizados pela função `availability_sync`.</p>
        </div>
        <a class="inline-flex items-center gap-2 text-sm text-secondary hover:underline" href="./appointments.html">Gerenciar agenda</a>
      </header>
      <div id="schedule" class="mt-6 grid md:grid-cols-3 gap-4 text-sm"></div>
    </section>

    <section class="grid lg:grid-cols-2 gap-6">
      <div class="rounded-3xl bg-slate-800/80 border border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-white">Avaliações recentes</h2>
        <div id="reviews" class="mt-4 space-y-4 text-sm"></div>
        <a class="mt-4 inline-flex items-center gap-2 text-sm text-secondary hover:underline" href="./reviews.html">Ver todas</a>
      </div>
      <div class="rounded-3xl bg-slate-800/80 border border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-white">Gamificação e recompensas</h2>
        <p class="text-sm text-slate-400">Resumo produzido pelo endpoint `/api/v1/gamification/summary`.</p>
        <div id="gamification" class="mt-6 space-y-3 text-sm"></div>
      </div>
    </section>
  </main>

  <script>
    async function loadDashboard() {
      try {
        const response = await fetch('/api/v1/dashboard/professional?user_id=current-professional');
        const payload = await response.json();
        const metrics = payload.data || {};
        document.getElementById('confirmed').textContent = `${metrics.next_appointments?.length || 0} nesta semana`;
        const rating = metrics.ratings?.average || 4.8;
        const count = metrics.ratings?.count || 0;
        document.getElementById('rating').textContent = `${rating.toFixed(2)} · ${count} avaliações`;
      } catch (error) {
        console.error(error);
      }
    }

    async function loadSchedule() {
      const container = document.getElementById('schedule');
      container.innerHTML = '';
      try {
        const response = await fetch('/api/v1/professionals/current-professional/availability');
        const payload = await response.json();
        (payload.data || []).slice(0, 6).forEach((slot) => {
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-slate-700 bg-slate-900/50 p-4';
          card.innerHTML = `<p class="text-xs text-slate-400 uppercase">${slot.channel}</p><p class="text-sm font-semibold text-white">${slot.date}</p><p class="text-sm text-slate-300">${slot.start_time} • ${slot.end_time}</p>`;
          container.appendChild(card);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function loadReviews() {
      const container = document.getElementById('reviews');
      container.innerHTML = '';
      try {
        const response = await fetch('/api/v1/professionals/current-professional/reviews');
        const payload = await response.json();
        (payload.data || []).slice(0, 3).forEach((review) => {
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-slate-700 bg-slate-900/50 p-4';
          card.innerHTML = `<p class="text-sm font-semibold text-white">${review.rater_name || 'Paciente VIVA'}</p><p class="text-xs text-slate-400">${(review.rating || 0).toFixed(1)} • ${review.published_at?.slice(0, 10) || ''}</p><p class="mt-2 text-sm text-slate-300">${review.comment || ''}</p>`;
          container.appendChild(card);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function loadGamification() {
      const container = document.getElementById('gamification');
      container.innerHTML = '';
      try {
        const response = await fetch('/api/v1/gamification/summary?user_id=current-professional');
        const payload = await response.json();
        const summary = payload.data || {};
        container.innerHTML = `<div class="rounded-2xl border border-slate-700 bg-slate-900/50 p-4"><p class="text-sm text-slate-300">Pontos totais</p><p class="text-2xl font-semibold text-secondary">${summary.total_points || 0}</p><p class="text-xs text-slate-500 mt-2">Badges: ${(summary.badges || []).join(', ') || 'Nenhum'}</p></div>`;
      } catch (error) {
        console.error(error);
      }
    }

    loadDashboard();
    loadSchedule();
    loadReviews();
    loadGamification();
  </script>
</body>
</html>
